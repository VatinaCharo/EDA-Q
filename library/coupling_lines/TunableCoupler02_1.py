
import gdspy, copy
from addict import Dict
import math as mt
from base.library_base import LibraryBase

class Tunablecoupler021(LibraryBase):
    default_options = Dict(
        name="Tunablecoupler0210",
        type="Tunablecoupler021",
        chip="chip0",
        gds_pos=(0, 0),
        topo_pos=(0, 0),
        outline=[],
        rotation=0
    )

    def __init__(self, options: Dict = None):
        super().__init__(options)
        return

    def _add_polygons_to_cell(self):
        polygon_data = [

            ([[-0.3, 0.0], [-0.19999999999999998, 0.0], [-0.19999999999999998, 0.5], [-0.3, 0.5], [-0.3, 0.0]], 1),

            ([[0.19999999999999998, 0.0], [0.3, 0.0], [0.3, 0.5], [0.19999999999999998, 0.5], [0.19999999999999998, 0.0]], 1),

            ([[-1.9, 0.0], [-0.3, 0.0], [-0.3, 0.09999999999999999], [-1.9, 0.09999999999999999], [-1.9, 0.0]], 1),

            ([[0.3, 0.0], [1.9, 0.0], [1.9, 0.09999999999999999], [0.3, 0.09999999999999999], [0.3, 0.0]], 1),

            ([[-0.65, 0.049999999999999996], [-0.6514449999999999, 0.020595], [-0.655764, -0.008527], [-0.662918, -0.037085], [-0.672836, -0.064805], [-0.6854239999999999, -0.091419], [-0.7005589999999999, -0.116671], [-0.718097, -0.140318], [-0.737868, -0.162132], [-0.759682, -0.18190299999999998], [-0.7833289999999999, -0.19944099999999998], [-0.808581, -0.214576], [-0.8351949999999999, -0.22716399999999998], [-0.862915, -0.237082], [-0.891473, -0.24423599999999998], [-0.9205949999999999, -0.248555], [-0.95, -0.25], [-0.979405, -0.248555], [-1.008527, -0.24423599999999998], [-1.037085, -0.237082], [-1.064805, -0.22716399999999998], [-1.091419, -0.214576], [-1.116671, -0.19944099999999998], [-1.140318, -0.18190299999999998], [-1.162132, -0.162132], [-1.181903, -0.140318], [-1.199441, -0.116671], [-1.2145759999999999, -0.091419], [-1.227164, -0.064805], [-1.237082, -0.037085], [-1.244236, -0.008527], [-1.2485549999999999, 0.020595], [-1.25, 0.049999999999999996], [-1.2485549999999999, 0.07940499999999999], [-1.244236, 0.108527], [-1.237082, 0.13708499999999998], [-1.227164, 0.16480499999999998], [-1.2145759999999999, 0.19141899999999998], [-1.199441, 0.216671], [-1.181903, 0.24031799999999998], [-1.162132, 0.262132], [-1.140318, 0.281903], [-1.116671, 0.299441], [-1.091419, 0.31457599999999997], [-1.064805, 0.327164], [-1.037085, 0.337082], [-1.008527, 0.344236], [-0.979405, 0.348555], [-0.95, 0.35], [-0.9205949999999999, 0.348555], [-0.891473, 0.344236], [-0.862915, 0.337082], [-0.8351949999999999, 0.327164], [-0.808581, 0.31457599999999997], [-0.7833289999999999, 0.299441], [-0.759682, 0.281903], [-0.737868, 0.262132], [-0.718097, 0.24031799999999998], [-0.7005589999999999, 0.216671], [-0.6854239999999999, 0.19141899999999998], [-0.672836, 0.16480499999999998], [-0.662918, 0.13708499999999998], [-0.655764, 0.108527], [-0.6514449999999999, 0.07940499999999999], [-0.65, 0.049999999999999996]], 1),

            ([[1.25, 0.049999999999999996], [1.2485549999999999, 0.020595], [1.244236, -0.008527], [1.237082, -0.037085], [1.227164, -0.064805], [1.2145759999999999, -0.091419], [1.199441, -0.116671], [1.181903, -0.140318], [1.162132, -0.162132], [1.140318, -0.18190299999999998], [1.116671, -0.19944099999999998], [1.091419, -0.214576], [1.064805, -0.22716399999999998], [1.037085, -0.237082], [1.008527, -0.24423599999999998], [0.979405, -0.248555], [0.95, -0.25], [0.9205949999999999, -0.248555], [0.891473, -0.24423599999999998], [0.862915, -0.237082], [0.8351949999999999, -0.22716399999999998], [0.808581, -0.214576], [0.7833289999999999, -0.19944099999999998], [0.759682, -0.18190299999999998], [0.737868, -0.162132], [0.718097, -0.140318], [0.7005589999999999, -0.116671], [0.6854239999999999, -0.091419], [0.672836, -0.064805], [0.662918, -0.037085], [0.655764, -0.008527], [0.6514449999999999, 0.020595], [0.65, 0.049999999999999996], [0.6514449999999999, 0.07940499999999999], [0.655764, 0.108527], [0.662918, 0.13708499999999998], [0.672836, 0.16480499999999998], [0.6854239999999999, 0.19141899999999998], [0.7005589999999999, 0.216671], [0.718097, 0.24031799999999998], [0.737868, 0.262132], [0.759682, 0.281903], [0.7833289999999999, 0.299441], [0.808581, 0.31457599999999997], [0.8351949999999999, 0.327164], [0.862915, 0.337082], [0.891473, 0.344236], [0.9205949999999999, 0.348555], [0.95, 0.35], [0.979405, 0.348555], [1.008527, 0.344236], [1.037085, 0.337082], [1.064805, 0.327164], [1.091419, 0.31457599999999997], [1.116671, 0.299441], [1.140318, 0.281903], [1.162132, 0.262132], [1.181903, 0.24031799999999998], [1.199441, 0.216671], [1.2145759999999999, 0.19141899999999998], [1.227164, 0.16480499999999998], [1.237082, 0.13708499999999998], [1.244236, 0.108527], [1.2485549999999999, 0.07940499999999999], [1.25, 0.049999999999999996]], 1),

            ([[-0.5, 0.5], [-0.39999999999999997, 0.5], [-0.39999999999999997, 1.0], [-0.5, 1.0], [-0.5, 0.5]], 1),

        ]

        for points in polygon_data:
            layer = points[-1]
            polygon_points = points[0]
            self.cell.add(gdspy.Polygon(polygon_points, layer=layer))

    def _calculate_bounding_box(self):
        min_x, min_y = float("inf"), float("inf")
        max_x, max_y = float("-inf"), float("-inf")

        for polygon in self.cell.polygons:
            bbox = polygon.get_bounding_box()
            if bbox is not None:
                min_x = min(min_x, bbox[0][0])
                min_y = min(min_y, bbox[0][1])
                max_x = max(max_x, bbox[1][0])
                max_y = max(max_y, bbox[1][1])

        if min_x == float("inf") or min_y == float("inf"):
            raise ValueError("No valid polygons found in the cell.")

        return min_x, min_y, max_x, max_y

    def _transform_polygons(self, dx, dy, rotation, center):
        for polygon in self.cell.polygons:
            polygon.translate(dx, dy)
            polygon.rotate(rotation, center=center)

    def calc_general_ops(self):
        self.lib = gdspy.GdsLibrary()
        gdspy.library.use_current_library = False
        self.cell = self.lib.new_cell(self.name + "_cell")

        self._add_polygons_to_cell()

        # Bounding box calculations
        min_x, min_y, max_x, max_y = self._calculate_bounding_box()
        current_center_x = (min_x + max_x) / 2
        current_center_y = (min_y + max_y) / 2

        # Target center
        target_center_x, target_center_y = self.options.gds_pos
        dx = target_center_x - current_center_x
        dy = target_center_y - current_center_y

        # Update gds_pos to match adjusted center
        self.options.gds_pos = (target_center_x, target_center_y)

        # Apply transformations
        self._transform_polygons(dx, dy, self.rotation, center=(target_center_x, target_center_y))
        self.outline = [
            points for polygon in self.cell.polygons for points in polygon.get_bounding_box().tolist()
        ]
        return

    def draw_gds(self):
        self.calc_general_ops()
