
import gdspy, copy
from addict import Dict
import math as mt
from base.library_base import LibraryBase

class Transmonconcentrictype21(LibraryBase):
    default_options = Dict(
        name="Transmonconcentrictype210",
        type="Transmonconcentrictype21",
        chip="chip0",
        gds_pos=(0, 0),
        topo_pos=(0, 0),
        outline=[],
        rotation=0
    )

    def __init__(self, options: Dict = None):
        super().__init__(options)
        return

    def _add_polygons_to_cell(self):
        polygon_data = [

            ([[1.961571, -0.390181], [1.913881, -0.580569], [1.847759, -0.765367], [1.7638429999999998, -0.942793], [1.662939, -1.11114], [1.5460209999999999, -1.2687869999999999], [1.4142139999999999, -1.4142139999999999], [1.2687869999999999, -1.5460209999999999], [1.11114, -1.662939], [0.942793, -1.7638429999999998], [0.765367, -1.847759], [0.580569, -1.913881], [0.390181, -1.961571], [0.19603399999999999, -1.9903689999999998], [0.0, -2.0], [-0.19603399999999999, -1.9903689999999998], [-0.390181, -1.961571], [-0.580569, -1.913881], [-0.765367, -1.847759], [-0.942793, -1.7638429999999998], [-1.11114, -1.662939], [-1.2687869999999999, -1.5460209999999999], [-1.4142139999999999, -1.4142139999999999], [-1.5460209999999999, -1.2687869999999999], [-1.662939, -1.11114], [-1.7638429999999998, -0.942793], [-1.847759, -0.765367], [-1.913881, -0.580569], [-1.961571, -0.390181], [-1.9903689999999998, -0.19603399999999999], [-2.0, 0.0], [-1.9903689999999998, 0.19603399999999999], [-1.961571, 0.390181], [-1.913881, 0.580569], [-1.847759, 0.765367], [-1.7638429999999998, 0.942793], [-1.662939, 1.11114], [-1.5460209999999999, 1.2687869999999999], [-1.4142139999999999, 1.4142139999999999], [-1.2687869999999999, 1.5460209999999999], [-1.11114, 1.662939], [-0.942793, 1.7638429999999998], [-0.765367, 1.847759], [-0.580569, 1.913881], [-0.39999999999999997, 1.9591109999999998], [-0.39999999999999997, 1.444285], [-0.43542699999999995, 1.435411], [-0.574025, 1.385819], [-0.7070949999999999, 1.322882], [-0.833355, 1.247204], [-0.9515899999999999, 1.159516], [-1.06066, 1.06066], [-1.159516, 0.9515899999999999], [-1.247204, 0.833355], [-1.322882, 0.7070949999999999], [-1.385819, 0.574025], [-1.435411, 0.43542699999999995], [-1.4711779999999999, 0.292635], [-1.492777, 0.147026], [-1.5, 0.0], [-1.492777, -0.147026], [-1.4711779999999999, -0.292635], [-1.435411, -0.43542699999999995], [-1.385819, -0.574025], [-1.322882, -0.7070949999999999], [-1.247204, -0.833355], [-1.159516, -0.9515899999999999], [-1.06066, -1.06066], [-0.9515899999999999, -1.159516], [-0.833355, -1.247204], [-0.7070949999999999, -1.322882], [-0.574025, -1.385819], [-0.43542699999999995, -1.435411], [-0.292635, -1.4711779999999999], [-0.147026, -1.492777], [0.0, -1.5], [0.147026, -1.492777], [0.292635, -1.4711779999999999], [0.43542699999999995, -1.435411], [0.574025, -1.385819], [0.7070949999999999, -1.322882], [0.833355, -1.247204], [0.9515899999999999, -1.159516], [1.06066, -1.06066], [1.159516, -0.9515899999999999], [1.247204, -0.833355], [1.322882, -0.7070949999999999], [1.385819, -0.574025], [1.435411, -0.43542699999999995], [1.4711779999999999, -0.292635], [1.492777, -0.147026], [1.5, 0.0], [1.492777, 0.147026], [1.4711779999999999, 0.292635], [1.435411, 0.43542699999999995], [1.385819, 0.574025], [1.322882, 0.7070949999999999], [1.247204, 0.833355], [1.159516, 0.9515899999999999], [1.06066, 1.06066], [0.9515899999999999, 1.159516], [0.833355, 1.247204], [0.7070949999999999, 1.322882], [0.574025, 1.385819], [0.43542699999999995, 1.435411], [0.39999999999999997, 1.444285], [0.39999999999999997, 1.9591109999999998], [0.580569, 1.913881], [0.765367, 1.847759], [0.942793, 1.7638429999999998], [1.11114, 1.662939], [1.2687869999999999, 1.5460209999999999], [1.4142139999999999, 1.4142139999999999], [1.5460209999999999, 1.2687869999999999], [1.662939, 1.11114], [1.7638429999999998, 0.942793], [1.847759, 0.765367], [1.913881, 0.580569], [1.961571, 0.390181], [1.9903689999999998, 0.19603399999999999], [2.0, 0.0], [1.9903689999999998, -0.19603399999999999], [1.961571, -0.390181]], 1),

            ([[1.0, 0.0], [0.995185, -0.09801699999999999], [0.9807849999999999, -0.19508999999999999], [0.9569399999999999, -0.29028499999999996], [0.9238799999999999, -0.382683], [0.881921, -0.47139699999999995], [0.8314699999999999, -0.55557], [0.77301, -0.634393], [0.7071069999999999, -0.7071069999999999], [0.634393, -0.77301], [0.55557, -0.8314699999999999], [0.47139699999999995, -0.881921], [0.382683, -0.9238799999999999], [0.29028499999999996, -0.9569399999999999], [0.19508999999999999, -0.9807849999999999], [0.09801699999999999, -0.995185], [0.0, -1.0], [-0.09801699999999999, -0.995185], [-0.19508999999999999, -0.9807849999999999], [-0.29028499999999996, -0.9569399999999999], [-0.382683, -0.9238799999999999], [-0.47139699999999995, -0.881921], [-0.55557, -0.8314699999999999], [-0.634393, -0.77301], [-0.7071069999999999, -0.7071069999999999], [-0.77301, -0.634393], [-0.8314699999999999, -0.55557], [-0.881921, -0.47139699999999995], [-0.9238799999999999, -0.382683], [-0.9569399999999999, -0.29028499999999996], [-0.9807849999999999, -0.19508999999999999], [-0.995185, -0.09801699999999999], [-1.0, 0.0], [-0.995185, 0.09801699999999999], [-0.9807849999999999, 0.19508999999999999], [-0.9569399999999999, 0.29028499999999996], [-0.9238799999999999, 0.382683], [-0.881921, 0.47139699999999995], [-0.8314699999999999, 0.55557], [-0.77301, 0.634393], [-0.7071069999999999, 0.7071069999999999], [-0.634393, 0.77301], [-0.55557, 0.8314699999999999], [-0.47139699999999995, 0.881921], [-0.382683, 0.9238799999999999], [-0.29028499999999996, 0.9569399999999999], [-0.19508999999999999, 0.9807849999999999], [-0.09801699999999999, 0.995185], [0.0, 1.0], [0.09801699999999999, 0.995185], [0.19508999999999999, 0.9807849999999999], [0.29028499999999996, 0.9569399999999999], [0.382683, 0.9238799999999999], [0.47139699999999995, 0.881921], [0.55557, 0.8314699999999999], [0.634393, 0.77301], [0.7071069999999999, 0.7071069999999999], [0.77301, 0.634393], [0.8314699999999999, 0.55557], [0.881921, 0.47139699999999995], [0.9238799999999999, 0.382683], [0.9569399999999999, 0.29028499999999996], [0.9807849999999999, 0.19508999999999999], [0.995185, 0.09801699999999999], [1.0, 0.0]], 1),

            ([[-3.1999999999999997, -0.35], [-2.5, -0.35], [-2.5, 0.35], [-3.1999999999999997, 0.35], [-3.1999999999999997, -0.35]], 1),

            ([[-1.0, 3.9499999999999997], [1.0, 3.9499999999999997], [0.0, 2.9499999999999997], [0.0, 2.9499999999999997], [-1.0, 3.9499999999999997], [-1.0, 3.9499999999999997]], 1),

            ([[1.414215, 1.767766], [1.732413, 2.0859639999999997], [2.085966, 1.73241], [1.767768, 1.414212], [1.695975, 1.486005], [1.9523009999999998, 1.742332], [1.7401689999999999, 1.954464], [1.483843, 1.698137], [1.414215, 1.767766]], 1),

            ([[-1.767768, 1.414212], [-2.085966, 1.73241], [-1.732413, 2.0859639999999997], [-1.414215, 1.767766], [-1.483843, 1.698137], [-1.7401689999999999, 1.954464], [-1.9523009999999998, 1.742332], [-1.695975, 1.486005], [-1.767768, 1.414212]], 1),

            ([[-1.414215, -1.767766], [-1.732413, -2.0859639999999997], [-2.085966, -1.73241], [-1.767768, -1.414212], [-1.69814, -1.483841], [-1.9544659999999998, -1.740167], [-1.7423339999999998, -1.952299], [-1.486008, -1.695973], [-1.414215, -1.767766]], 1),

            ([[1.44957, 1.378857], [1.3788589999999998, 1.449568], [1.732413, 1.803121], [1.8031229999999998, 1.73241]], 1),

            ([[-1.3788589999999998, 1.449568], [-1.44957, 1.378857], [-1.8031229999999998, 1.73241], [-1.732413, 1.803121]], 1),

            ([[-1.44957, -1.378857], [-1.3788589999999998, -1.449568], [-1.732413, -1.803121], [-1.8031229999999998, -1.73241]], 1),

            ([[-2.0, 0.049999999999999996], [-2.0, -0.049999999999999996], [-2.5, -0.049999999999999996], [-2.5, 0.049999999999999996]], 1),

            ([[0.049999999999999996, 1.0], [-0.049999999999999996, 1.0], [-0.049999999999999996, 3.0], [0.049999999999999996, 3.0]], 1),

        ]

        for points in polygon_data:
            layer = points[-1]
            polygon_points = points[0]
            self.cell.add(gdspy.Polygon(polygon_points, layer=layer))

    def _calculate_bounding_box(self):
        min_x, min_y = float("inf"), float("inf")
        max_x, max_y = float("-inf"), float("-inf")

        for polygon in self.cell.polygons:
            bbox = polygon.get_bounding_box()
            if bbox is not None:
                min_x = min(min_x, bbox[0][0])
                min_y = min(min_y, bbox[0][1])
                max_x = max(max_x, bbox[1][0])
                max_y = max(max_y, bbox[1][1])

        if min_x == float("inf") or min_y == float("inf"):
            raise ValueError("No valid polygons found in the cell.")

        return min_x, min_y, max_x, max_y

    def _transform_polygons(self, dx, dy, rotation, center):
        for polygon in self.cell.polygons:
            polygon.translate(dx, dy)
            polygon.rotate(rotation, center=center)

    def calc_general_ops(self):
        self.lib = gdspy.GdsLibrary()
        gdspy.library.use_current_library = False
        self.cell = self.lib.new_cell(self.name + "_cell")

        self._add_polygons_to_cell()

        # Bounding box calculations
        min_x, min_y, max_x, max_y = self._calculate_bounding_box()
        current_center_x = (min_x + max_x) / 2
        current_center_y = (min_y + max_y) / 2

        # Target center
        target_center_x, target_center_y = self.options.gds_pos
        dx = target_center_x - current_center_x
        dy = target_center_y - current_center_y

        # Update gds_pos to match adjusted center
        self.options.gds_pos = (target_center_x, target_center_y)

        # Apply transformations
        self._transform_polygons(dx, dy, self.rotation, center=(target_center_x, target_center_y))
        self.outline = [
            points for polygon in self.cell.polygons for points in polygon.get_bounding_box().tolist()
        ]
        return

    def draw_gds(self):
        self.calc_general_ops()
