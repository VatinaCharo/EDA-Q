
import gdspy, copy
from addict import Dict
import math as mt
from base.library_base import LibraryBase

class Starqubit1(LibraryBase):
    default_options = Dict(
        name="Starqubit10",
        type="Starqubit1",
        chip="chip0",
        gds_pos=(0, 0),
        topo_pos=(0, 0),
        outline=[],
        rotation=0
    )

    def __init__(self, options: Dict = None):
        super().__init__(options)
        return

    def _add_polygons_to_cell(self):
        polygon_data = [

            ([[0.190318, -0.231903], [0.16667099999999999, -0.249441], [0.141419, -0.264576], [0.11480499999999999, -0.27716399999999997], [0.11231899999999999, -0.278053], [0.049999999999999996, -0.09999999999999999], [-0.049999999999999996, -0.09999999999999999], [-0.11231899999999999, -0.278053], [-0.11480499999999999, -0.27716399999999997], [-0.141419, -0.264576], [-0.16667099999999999, -0.249441], [-0.190318, -0.231903], [-0.212132, -0.212132], [-0.22971699999999998, -0.19272999999999998], [-0.07965499999999999, -0.078455], [-0.11055699999999999, 0.016651], [-0.29897399999999996, 0.020894], [-0.29855499999999996, 0.029404999999999997], [-0.294236, 0.058526999999999996], [-0.287082, 0.087085], [-0.27716399999999997, 0.11480499999999999], [-0.264576, 0.141419], [-0.254146, 0.158821], [-0.099229, 0.051511999999999995], [-0.018328, 0.110291], [-0.07249799999999999, 0.290736], [-0.058526999999999996, 0.294236], [-0.04, 0.29698399999999997], [-0.04, 0.35], [-0.015, 0.35], [-0.015, 0.299263], [0.0, 0.3], [0.015, 0.299263], [0.015, 0.35], [0.04, 0.35], [0.04, 0.29698399999999997], [0.058526999999999996, 0.294236], [0.07249799999999999, 0.290736], [0.018328, 0.110291], [0.099229, 0.051511999999999995], [0.254146, 0.158821], [0.264576, 0.141419], [0.27716399999999997, 0.11480499999999999], [0.287082, 0.087085], [0.294236, 0.058526999999999996], [0.29855499999999996, 0.029404999999999997], [0.29897399999999996, 0.020894], [0.11055699999999999, 0.016651], [0.07965499999999999, -0.078455], [0.22971699999999998, -0.19272999999999998], [0.212132, -0.212132], [0.190318, -0.231903]], 1),

            ([[0.0375, -0.297355], [0.0375, -0.375], [-0.0375, -0.375], [-0.0375, -0.297355], [-0.058526999999999996, -0.294236], [-0.072363, -0.29077], [-0.024999999999999998, -0.125], [0.024999999999999998, -0.125], [0.072363, -0.29077], [0.058526999999999996, -0.294236], [0.0375, -0.297355]], 1),

            ([[0.29456899999999997, -0.056281], [0.368234, -0.080217], [0.345058, -0.151546], [0.27114499999999997, -0.12753], [0.264576, -0.141419], [0.254218, -0.15870099999999998], [0.11115699999999999, -0.062403999999999994], [0.126607, -0.014851], [0.298967, -0.021034], [0.29855499999999996, -0.029404999999999997], [0.29456899999999997, -0.056281]], 1),

            ([[-0.20510399999999998, 0.218502], [-0.250758, 0.281339], [-0.190081, 0.32542299999999996], [-0.14452199999999998, 0.262716], [-0.141419, 0.264576], [-0.11480499999999999, 0.27716399999999997], [-0.112453, 0.278005], [-0.053248, 0.115822], [-0.09369899999999999, 0.086432], [-0.229621, 0.19283599999999998], [-0.212132, 0.212132], [-0.20510399999999998, 0.218502]], 1),

            ([[-0.27114499999999997, -0.12753], [-0.345058, -0.151546], [-0.368234, -0.080217], [-0.29456899999999997, -0.056281], [-0.29855499999999996, -0.029404999999999997], [-0.298967, -0.021034], [-0.126607, -0.014851], [-0.11115699999999999, -0.062403999999999994], [-0.254218, -0.15870099999999998], [-0.264576, -0.141419], [-0.27114499999999997, -0.12753]], 1),

            ([[0.125598, 0.272443], [0.144443, 0.262607], [0.190081, 0.32542299999999996], [0.250758, 0.281339], [0.205119, 0.218523], [0.220297, 0.20364], [0.239196, 0.18106699999999998], [0.243949, 0.17410299999999998], [0.09701699999999999, 0.06548], [0.032296, 0.11250299999999999], [0.090197, 0.28581], [0.098289, 0.28344199999999997], [0.125598, 0.272443]], 1),

            ([[0.44999999999999996, 0.44999999999999996], [-0.44999999999999996, 0.44999999999999996], [-0.44999999999999996, 0.0], [-0.375, 0.0], [-0.37319399999999997, 0.036756], [-0.367794, 0.073159], [-0.358853, 0.108857], [-0.34645499999999996, 0.143506], [-0.33071999999999996, 0.176774], [-0.311801, 0.208339], [-0.289879, 0.237897], [-0.265165, 0.265165], [-0.26057199999999997, 0.269328], [-0.262893, 0.272523], [-0.177946, 0.33424], [-0.17574299999999998, 0.331208], [-0.143506, 0.34645499999999996], [-0.108857, 0.358853], [-0.073159, 0.367794], [-0.036756, 0.37319399999999997], [0.0, 0.375], [0.036756, 0.37319399999999997], [0.073159, 0.367794], [0.108857, 0.358853], [0.143506, 0.34645499999999996], [0.17574299999999998, 0.331208], [0.177946, 0.33424], [0.262893, 0.272523], [0.26057199999999997, 0.269328], [0.265165, 0.265165], [0.289879, 0.237897], [0.311801, 0.208339], [0.33071999999999996, 0.176774], [0.34645499999999996, 0.143506], [0.358853, 0.108857], [0.367794, 0.073159], [0.37319399999999997, 0.036756], [0.375, 0.0], [0.37319399999999997, -0.036756], [0.369048, -0.064709], [0.37287, -0.065951], [0.340423, -0.165812], [0.336507, -0.164539], [0.33071999999999996, -0.176774], [0.311801, -0.208339], [0.289879, -0.237897], [0.265165, -0.265165], [0.237897, -0.289879], [0.208339, -0.311801], [0.176774, -0.33071999999999996], [0.143506, -0.34645499999999996], [0.108857, -0.358853], [0.073159, -0.367794], [0.0525, -0.370859], [0.0525, -0.375], [-0.0525, -0.375], [-0.0525, -0.370859], [-0.073159, -0.367794], [-0.108857, -0.358853], [-0.143506, -0.34645499999999996], [-0.176774, -0.33071999999999996], [-0.208339, -0.311801], [-0.237897, -0.289879], [-0.265165, -0.265165], [-0.289879, -0.237897], [-0.311801, -0.208339], [-0.33071999999999996, -0.176774], [-0.336507, -0.164539], [-0.340423, -0.165812], [-0.37287, -0.065951], [-0.369048, -0.064709], [-0.37319399999999997, -0.036756], [-0.375, 0.0], [-0.44999999999999996, 0.0], [-0.44999999999999996, -0.44999999999999996], [0.44999999999999996, -0.44999999999999996]], 1),

            ([[-0.396879, -0.047466], [-0.39810399999999996, -0.039209999999999995], [-0.40003, 0.0], [-0.39810399999999996, 0.039209999999999995], [-0.39234399999999997, 0.078042], [-0.382805, 0.11612299999999999], [-0.36957999999999996, 0.153085], [-0.35279499999999997, 0.188573], [-0.332613, 0.222245], [-0.309227, 0.253776], [-0.293101, 0.271569], [-0.297813, 0.278053], [-0.17241499999999998, 0.36916], [-0.16769799999999999, 0.362668], [-0.153085, 0.36957999999999996], [-0.11612299999999999, 0.382805], [-0.078042, 0.39234399999999997], [-0.039209999999999995, 0.39810399999999996], [0.0, 0.40003], [0.039209999999999995, 0.39810399999999996], [0.078042, 0.39234399999999997], [0.11612299999999999, 0.382805], [0.153085, 0.36957999999999996], [0.16769799999999999, 0.362668], [0.17241499999999998, 0.36916], [0.297813, 0.278053], [0.293101, 0.271569], [0.309227, 0.253776], [0.332613, 0.222245], [0.35279499999999997, 0.188573], [0.36957999999999996, 0.153085], [0.382805, 0.11612299999999999], [0.39234399999999997, 0.078042], [0.39810399999999996, 0.039209999999999995], [0.40003, 0.0], [0.39810399999999996, -0.039209999999999995], [0.396879, -0.047466], [0.404371, -0.0499], [0.35647399999999996, -0.197314], [0.34901, -0.19488799999999998], [0.332613, -0.222245], [0.309227, -0.253776], [0.282864, -0.282864], [0.253776, -0.309227], [0.222245, -0.332613], [0.188573, -0.35279499999999997], [0.153085, -0.36957999999999996], [0.11612299999999999, -0.382805], [0.078042, -0.39234399999999997], [0.0775, -0.392424], [0.0775, -0.39999999999999997], [-0.0775, -0.39999999999999997], [-0.0775, -0.392424], [-0.078042, -0.39234399999999997], [-0.11612299999999999, -0.382805], [-0.153085, -0.36957999999999996], [-0.188573, -0.35279499999999997], [-0.222245, -0.332613], [-0.253776, -0.309227], [-0.282864, -0.282864], [-0.309227, -0.253776], [-0.332613, -0.222245], [-0.34901, -0.19488799999999998], [-0.35647399999999996, -0.197314], [-0.404371, -0.0499], [-0.396879, -0.047466]], 1),

        ]

        for points in polygon_data:
            layer = points[-1]
            polygon_points = points[0]
            self.cell.add(gdspy.Polygon(polygon_points, layer=layer))

    def _calculate_bounding_box(self):
        min_x, min_y = float("inf"), float("inf")
        max_x, max_y = float("-inf"), float("-inf")

        for polygon in self.cell.polygons:
            bbox = polygon.get_bounding_box()
            if bbox is not None:
                min_x = min(min_x, bbox[0][0])
                min_y = min(min_y, bbox[0][1])
                max_x = max(max_x, bbox[1][0])
                max_y = max(max_y, bbox[1][1])

        if min_x == float("inf") or min_y == float("inf"):
            raise ValueError("No valid polygons found in the cell.")

        return min_x, min_y, max_x, max_y

    def _transform_polygons(self, dx, dy, rotation, center):
        for polygon in self.cell.polygons:
            polygon.translate(dx, dy)
            polygon.rotate(rotation, center=center)

    def calc_general_ops(self):
        self.lib = gdspy.GdsLibrary()
        gdspy.library.use_current_library = False
        self.cell = self.lib.new_cell(self.name + "_cell")

        self._add_polygons_to_cell()

        # Bounding box calculations
        min_x, min_y, max_x, max_y = self._calculate_bounding_box()
        current_center_x = (min_x + max_x) / 2
        current_center_y = (min_y + max_y) / 2

        # Target center
        target_center_x, target_center_y = self.options.gds_pos
        dx = target_center_x - current_center_x
        dy = target_center_y - current_center_y

        # Update gds_pos to match adjusted center
        self.options.gds_pos = (target_center_x, target_center_y)

        # Apply transformations
        self._transform_polygons(dx, dy, self.rotation, center=(target_center_x, target_center_y))
        self.outline = [
            points for polygon in self.cell.polygons for points in polygon.get_bounding_box().tolist()
        ]
        return

    def draw_gds(self):
        self.calc_general_ops()
