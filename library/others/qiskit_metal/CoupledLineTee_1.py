
import gdspy, copy
from addict import Dict
import math as mt
from base.library_base import LibraryBase

class Coupledlinetee1(LibraryBase):
    default_options = Dict(
        name="Coupledlinetee10",
        type="Coupledlinetee1",
        chip="chip0",
        gds_pos=(0, 0),
        topo_pos=(0, 0),
        outline=[],
        rotation=0
    )

    def __init__(self, options: Dict = None):
        super().__init__(options)
        return

    def _add_polygons_to_cell(self):
        polygon_data = [

            ([[-0.09999999999999999, -0.005], [-0.09999999999999999, 0.005], [0.09999999999999999, 0.005], [0.09999999999999999, -0.005]], 1),

            ([[-0.049999999999999996, -0.02], [-0.049999999999999996, -0.03], [0.024999999999999998, -0.03], [0.026255999999999998, -0.030039], [0.027507, -0.030157999999999997], [0.028748, -0.030354], [0.029973999999999997, -0.030628], [0.03118, -0.030979], [0.032362, -0.031404], [0.033516, -0.031903], [0.034635, -0.032473999999999996], [0.035717, -0.033113], [0.036756, -0.033819999999999996], [0.037748, -0.034589999999999996], [0.038690999999999996, -0.035421], [0.039578999999999996, -0.036309], [0.04041, -0.037252], [0.04118, -0.038244], [0.041887, -0.039283], [0.042526, -0.040365], [0.043096999999999996, -0.041484], [0.043595999999999996, -0.042637999999999995], [0.044021, -0.04382], [0.044371999999999995, -0.045026], [0.044646, -0.046251999999999995], [0.044842, -0.047493], [0.044961, -0.048743999999999996], [0.045, -0.049999999999999996], [0.045, -0.125], [0.055, -0.125], [0.055, -0.049999999999999996], [0.054959, -0.04843], [0.054835999999999996, -0.046863999999999996], [0.054631, -0.045307], [0.054343999999999996, -0.043762999999999996], [0.053978, -0.042234999999999995], [0.053531999999999996, -0.040729], [0.053007, -0.039249], [0.052405999999999994, -0.037798], [0.05173, -0.036379999999999996], [0.050981, -0.034999999999999996], [0.050159999999999996, -0.033660999999999996], [0.049270999999999995, -0.032366], [0.048313999999999996, -0.03112], [0.047293999999999996, -0.029925999999999998], [0.046213, -0.028787], [0.045073999999999996, -0.027705999999999998], [0.043879999999999995, -0.026685999999999998], [0.042634, -0.025729], [0.041339, -0.024839999999999997], [0.04, -0.024019], [0.03862, -0.02327], [0.037202, -0.022594], [0.035751, -0.021993], [0.034270999999999996, -0.021467999999999998], [0.032764999999999996, -0.021022], [0.031236999999999997, -0.020656], [0.029692999999999997, -0.020368999999999998], [0.028135999999999998, -0.020163999999999998], [0.02657, -0.020041], [0.024999999999999998, -0.02]], 1),

            ([[0.12, 0.012499999999999999], [-0.12, 0.012499999999999999], [-0.12, -0.011], [-0.09999999999999999, -0.011], [-0.09999999999999999, 0.011], [0.09999999999999999, 0.011], [0.09999999999999999, -0.011], [-0.09999999999999999, -0.011], [-0.12, -0.011], [-0.12, -0.036], [-0.055999999999999994, -0.036], [-0.055999999999999994, -0.013999999999999999], [0.024999999999999998, -0.013999999999999999], [0.026712999999999997, -0.014041], [0.028422, -0.014162999999999999], [0.030122999999999997, -0.014365999999999999], [0.031813, -0.014650999999999999], [0.033486999999999996, -0.015014999999999999], [0.035142, -0.015458], [0.036774, -0.015979999999999998], [0.03838, -0.016579], [0.039955, -0.017252999999999998], [0.041496, -0.018002], [0.043, -0.018823], [0.044462999999999996, -0.019715], [0.045882, -0.020675], [0.047254, -0.021702], [0.048575, -0.022792999999999997], [0.049843, -0.023946], [0.051053999999999995, -0.025157], [0.052206999999999996, -0.026424999999999997], [0.053298, -0.027746], [0.054325, -0.029117999999999998], [0.055285, -0.030536999999999998], [0.056177, -0.032], [0.056998, -0.033504], [0.057747, -0.035045], [0.058421, -0.03662], [0.059019999999999996, -0.038225999999999996], [0.059542, -0.039858], [0.059985, -0.041513], [0.060349, -0.043186999999999996], [0.060634, -0.044877], [0.060836999999999995, -0.046578], [0.060959, -0.048287], [0.061, -0.049999999999999996], [0.061, -0.125], [0.039, -0.125], [0.039, -0.049999999999999996], [0.038960999999999996, -0.048954], [0.038844, -0.047913], [0.038648999999999996, -0.046884999999999996], [0.038377999999999995, -0.045873], [0.038031999999999996, -0.044885], [0.037614, -0.043926], [0.037124, -0.043], [0.036566999999999995, -0.042114], [0.035946, -0.041270999999999995], [0.035262999999999996, -0.040478], [0.034522, -0.039737], [0.033728999999999995, -0.039054], [0.032886, -0.038432999999999995], [0.032, -0.037876], [0.031073999999999997, -0.037385999999999996], [0.030115, -0.036968], [0.029127, -0.036622], [0.028114999999999998, -0.036351], [0.027087, -0.036156], [0.026046, -0.036039], [0.024999999999999998, -0.036], [-0.055999999999999994, -0.036], [-0.12, -0.036], [-0.12, -0.13749999999999998], [0.12, -0.13749999999999998]], 1),

            ([[-0.081, -0.036], [-0.125, -0.036], [-0.125, 0.036], [0.125, 0.036], [0.125, -0.036], [0.086, -0.036], [0.086, -0.15], [0.013999999999999999, -0.15], [0.013999999999999999, -0.061], [-0.081, -0.061], [-0.081, -0.036]], 1),

        ]

        for points in polygon_data:
            layer = points[-1]
            polygon_points = points[0]
            self.cell.add(gdspy.Polygon(polygon_points, layer=layer))

    def _calculate_bounding_box(self):
        min_x, min_y = float("inf"), float("inf")
        max_x, max_y = float("-inf"), float("-inf")

        for polygon in self.cell.polygons:
            bbox = polygon.get_bounding_box()
            if bbox is not None:
                min_x = min(min_x, bbox[0][0])
                min_y = min(min_y, bbox[0][1])
                max_x = max(max_x, bbox[1][0])
                max_y = max(max_y, bbox[1][1])

        if min_x == float("inf") or min_y == float("inf"):
            raise ValueError("No valid polygons found in the cell.")

        return min_x, min_y, max_x, max_y

    def _transform_polygons(self, dx, dy, rotation, center):
        for polygon in self.cell.polygons:
            polygon.translate(dx, dy)
            polygon.rotate(rotation, center=center)

    def calc_general_ops(self):
        self.lib = gdspy.GdsLibrary()
        gdspy.library.use_current_library = False
        self.cell = self.lib.new_cell(self.name + "_cell")

        self._add_polygons_to_cell()

        # Bounding box calculations
        min_x, min_y, max_x, max_y = self._calculate_bounding_box()
        current_center_x = (min_x + max_x) / 2
        current_center_y = (min_y + max_y) / 2

        # Target center
        target_center_x, target_center_y = self.options.gds_pos
        dx = target_center_x - current_center_x
        dy = target_center_y - current_center_y

        # Update gds_pos to match adjusted center
        self.options.gds_pos = (target_center_x, target_center_y)

        # Apply transformations
        self._transform_polygons(dx, dy, self.rotation, center=(target_center_x, target_center_y))
        self.outline = [
            points for polygon in self.cell.polygons for points in polygon.get_bounding_box().tolist()
        ]
        return

    def draw_gds(self):
        self.calc_general_ops()
