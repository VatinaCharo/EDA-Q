
import gdspy, copy
from addict import Dict
import math as mt
from base.library_base import LibraryBase

class Circlecaterpillar1(LibraryBase):
    default_options = Dict(
        name="Circlecaterpillar10",
        type="Circlecaterpillar1",
        chip="chip0",
        gds_pos=(0, 0),
        topo_pos=(0, 0),
        outline=[],
        rotation=0
    )

    def __init__(self, options: Dict = None):
        super().__init__(options)
        return

    def _add_polygons_to_cell(self):
        polygon_data = [

            ([[-1.325195, -0.27716399999999997], [-1.3529149999999999, -0.287082], [-1.381473, -0.294236], [-1.410595, -0.29855499999999996], [-1.44, -0.3], [-1.4694049999999999, -0.29855499999999996], [-1.498527, -0.294236], [-1.527085, -0.287082], [-1.554805, -0.27716399999999997], [-1.581419, -0.264576], [-1.606671, -0.249441], [-1.630318, -0.231903], [-1.652132, -0.212132], [-1.671903, -0.190318], [-1.689441, -0.16667099999999999], [-1.7045759999999999, -0.141419], [-1.717164, -0.11480499999999999], [-1.727082, -0.087085], [-1.7342359999999999, -0.058526999999999996], [-1.7385549999999999, -0.029404999999999997], [-1.74, 0.0], [-1.7385549999999999, 0.029404999999999997], [-1.7342359999999999, 0.058526999999999996], [-1.727082, 0.087085], [-1.717164, 0.11480499999999999], [-1.7045759999999999, 0.141419], [-1.689441, 0.16667099999999999], [-1.671903, 0.190318], [-1.652132, 0.212132], [-1.630318, 0.231903], [-1.606671, 0.249441], [-1.581419, 0.264576], [-1.554805, 0.27716399999999997], [-1.527085, 0.287082], [-1.498527, 0.294236], [-1.4694049999999999, 0.29855499999999996], [-1.44, 0.3], [-1.410595, 0.29855499999999996], [-1.381473, 0.294236], [-1.3529149999999999, 0.287082], [-1.325195, 0.27716399999999997], [-1.298581, 0.264576], [-1.273329, 0.249441], [-1.26, 0.239555], [-1.2466709999999999, 0.249441], [-1.221419, 0.264576], [-1.194805, 0.27716399999999997], [-1.167085, 0.287082], [-1.1385269999999998, 0.294236], [-1.109405, 0.29855499999999996], [-1.0799999999999998, 0.3], [-1.050595, 0.29855499999999996], [-1.0214729999999999, 0.294236], [-0.992915, 0.287082], [-0.9651949999999999, 0.27716399999999997], [-0.938581, 0.264576], [-0.913329, 0.249441], [-0.8999999999999999, 0.239555], [-0.886671, 0.249441], [-0.8614189999999999, 0.264576], [-0.8348049999999999, 0.27716399999999997], [-0.8070849999999999, 0.287082], [-0.778527, 0.294236], [-0.749405, 0.29855499999999996], [-0.72, 0.3], [-0.690595, 0.29855499999999996], [-0.661473, 0.294236], [-0.632915, 0.287082], [-0.6051949999999999, 0.27716399999999997], [-0.578581, 0.264576], [-0.553329, 0.249441], [-0.5399999999999999, 0.239555], [-0.526671, 0.249441], [-0.501419, 0.264576], [-0.474805, 0.27716399999999997], [-0.44708499999999995, 0.287082], [-0.418527, 0.294236], [-0.389405, 0.29855499999999996], [-0.36, 0.3], [-0.33059499999999997, 0.29855499999999996], [-0.301473, 0.294236], [-0.27291499999999996, 0.287082], [-0.245195, 0.27716399999999997], [-0.218581, 0.264576], [-0.193329, 0.249441], [-0.18, 0.239555], [-0.16667099999999999, 0.249441], [-0.141419, 0.264576], [-0.11480499999999999, 0.27716399999999997], [-0.087085, 0.287082], [-0.058526999999999996, 0.294236], [-0.029404999999999997, 0.29855499999999996], [0.0, 0.3], [0.029404999999999997, 0.29855499999999996], [0.058526999999999996, 0.294236], [0.07554799999999999, 0.289972], [0.299626, 0.0076089999999999994], [0.3, 0.0], [0.29855499999999996, -0.029404999999999997], [0.294236, -0.058526999999999996], [0.287082, -0.087085], [0.27716399999999997, -0.11480499999999999], [0.264576, -0.141419], [0.249441, -0.16667099999999999], [0.231903, -0.190318], [0.212132, -0.212132], [0.190318, -0.231903], [0.16667099999999999, -0.249441], [0.141419, -0.264576], [0.11480499999999999, -0.27716399999999997], [0.087085, -0.287082], [0.058526999999999996, -0.294236], [0.029404999999999997, -0.29855499999999996], [0.0, -0.3], [-0.029404999999999997, -0.29855499999999996], [-0.058526999999999996, -0.294236], [-0.087085, -0.287082], [-0.11480499999999999, -0.27716399999999997], [-0.141419, -0.264576], [-0.16667099999999999, -0.249441], [-0.18, -0.239555], [-0.193329, -0.249441], [-0.218581, -0.264576], [-0.245195, -0.27716399999999997], [-0.27291499999999996, -0.287082], [-0.301473, -0.294236], [-0.33059499999999997, -0.29855499999999996], [-0.36, -0.3], [-0.389405, -0.29855499999999996], [-0.418527, -0.294236], [-0.44708499999999995, -0.287082], [-0.474805, -0.27716399999999997], [-0.501419, -0.264576], [-0.526671, -0.249441], [-0.5399999999999999, -0.239555], [-0.553329, -0.249441], [-0.578581, -0.264576], [-0.6051949999999999, -0.27716399999999997], [-0.632915, -0.287082], [-0.661473, -0.294236], [-0.690595, -0.29855499999999996], [-0.72, -0.3], [-0.749405, -0.29855499999999996], [-0.778527, -0.294236], [-0.8070849999999999, -0.287082], [-0.8348049999999999, -0.27716399999999997], [-0.8614189999999999, -0.264576], [-0.886671, -0.249441], [-0.8999999999999999, -0.239555], [-0.913329, -0.249441], [-0.938581, -0.264576], [-0.9651949999999999, -0.27716399999999997], [-0.992915, -0.287082], [-1.0214729999999999, -0.294236], [-1.050595, -0.29855499999999996], [-1.0799999999999998, -0.3], [-1.109405, -0.29855499999999996], [-1.1385269999999998, -0.294236], [-1.167085, -0.287082], [-1.194805, -0.27716399999999997], [-1.221419, -0.264576], [-1.2466709999999999, -0.249441], [-1.26, -0.239555], [-1.273329, -0.249441], [-1.298581, -0.264576], [-1.325195, -0.27716399999999997]], 1),

        ]

        for points in polygon_data:
            layer = points[-1]
            polygon_points = points[0]
            self.cell.add(gdspy.Polygon(polygon_points, layer=layer))

    def _calculate_bounding_box(self):
        min_x, min_y = float("inf"), float("inf")
        max_x, max_y = float("-inf"), float("-inf")

        for polygon in self.cell.polygons:
            bbox = polygon.get_bounding_box()
            if bbox is not None:
                min_x = min(min_x, bbox[0][0])
                min_y = min(min_y, bbox[0][1])
                max_x = max(max_x, bbox[1][0])
                max_y = max(max_y, bbox[1][1])

        if min_x == float("inf") or min_y == float("inf"):
            raise ValueError("No valid polygons found in the cell.")

        return min_x, min_y, max_x, max_y

    def _transform_polygons(self, dx, dy, rotation, center):
        for polygon in self.cell.polygons:
            polygon.translate(dx, dy)
            polygon.rotate(rotation, center=center)

    def calc_general_ops(self):
        self.lib = gdspy.GdsLibrary()
        gdspy.library.use_current_library = False
        self.cell = self.lib.new_cell(self.name + "_cell")

        self._add_polygons_to_cell()

        # Bounding box calculations
        min_x, min_y, max_x, max_y = self._calculate_bounding_box()
        current_center_x = (min_x + max_x) / 2
        current_center_y = (min_y + max_y) / 2

        # Target center
        target_center_x, target_center_y = self.options.gds_pos
        dx = target_center_x - current_center_x
        dy = target_center_y - current_center_y

        # Update gds_pos to match adjusted center
        self.options.gds_pos = (target_center_x, target_center_y)

        # Apply transformations
        self._transform_polygons(dx, dy, self.rotation, center=(target_center_x, target_center_y))
        self.outline = [
            points for polygon in self.cell.polygons for points in polygon.get_bounding_box().tolist()
        ]
        return

    def draw_gds(self):
        self.calc_general_ops()
