
import gdspy, copy
from addict import Dict
import math as mt
from base.library_base import LibraryBase

class Transmonconcentric1(LibraryBase):
    default_options = Dict(
        name="Transmonconcentric10",
        type="Transmonconcentric1",
        chip="chip0",
        gds_pos=(0, 0),
        topo_pos=(0, 0),
        outline=[],
        rotation=0
    )

    def __init__(self, options: Dict = None):
        super().__init__(options)
        return

    def _add_polygons_to_cell(self):
        polygon_data = [

            ([[0.016663, -0.169181], [0.033165, -0.166733], [0.049347999999999996, -0.16268], [0.065056, -0.15706], [0.080137, -0.149927], [0.09444699999999999, -0.14135], [0.107847, -0.131412], [0.120208, -0.120208], [0.131412, -0.107847], [0.14135, -0.09444699999999999], [0.149927, -0.080137], [0.15706, -0.065056], [0.16268, -0.049347999999999996], [0.166733, -0.033165], [0.169181, -0.016663], [0.16999999999999998, 0.0], [0.169181, 0.016663], [0.166733, 0.033165], [0.16268, 0.049347999999999996], [0.15706, 0.065056], [0.149927, 0.080137], [0.14135, 0.09444699999999999], [0.131412, 0.107847], [0.120208, 0.120208], [0.107847, 0.131412], [0.09444699999999999, 0.14135], [0.080137, 0.149927], [0.065056, 0.15706], [0.049347999999999996, 0.16268], [0.033165, 0.166733], [0.016663, 0.169181], [0.0, 0.16999999999999998], [-0.016663, 0.169181], [-0.033165, 0.166733], [-0.049347999999999996, 0.16268], [-0.065056, 0.15706], [-0.080137, 0.149927], [-0.09444699999999999, 0.14135], [-0.107847, 0.131412], [-0.120208, 0.120208], [-0.131412, 0.107847], [-0.14135, 0.09444699999999999], [-0.149927, 0.080137], [-0.15706, 0.065056], [-0.16268, 0.049347999999999996], [-0.166733, 0.033165], [-0.169181, 0.016663], [-0.16999999999999998, 0.0], [-0.15, 0.0], [-0.149278, 0.014702999999999999], [-0.147118, 0.029264], [-0.143541, 0.043543], [-0.13858199999999998, 0.057402999999999996], [-0.132288, 0.07071], [-0.12472, 0.083336], [-0.115952, 0.095159], [-0.106066, 0.106066], [-0.095159, 0.115952], [-0.083336, 0.12472], [-0.07071, 0.132288], [-0.057402999999999996, 0.13858199999999998], [-0.043543, 0.143541], [-0.029264, 0.147118], [-0.014702999999999999, 0.149278], [0.0, 0.15], [0.014702999999999999, 0.149278], [0.029264, 0.147118], [0.043543, 0.143541], [0.057402999999999996, 0.13858199999999998], [0.07071, 0.132288], [0.083336, 0.12472], [0.095159, 0.115952], [0.106066, 0.106066], [0.115952, 0.095159], [0.12472, 0.083336], [0.132288, 0.07071], [0.13858199999999998, 0.057402999999999996], [0.143541, 0.043543], [0.147118, 0.029264], [0.149278, 0.014702999999999999], [0.15, 0.0], [0.149278, -0.014702999999999999], [0.147118, -0.029264], [0.143541, -0.043543], [0.13858199999999998, -0.057402999999999996], [0.132288, -0.07071], [0.12472, -0.083336], [0.115952, -0.095159], [0.106066, -0.106066], [0.095159, -0.115952], [0.083336, -0.12472], [0.07071, -0.132288], [0.057402999999999996, -0.13858199999999998], [0.043543, -0.143541], [0.029264, -0.147118], [0.014702999999999999, -0.149278], [0.0, -0.15], [-0.014702999999999999, -0.149278], [-0.029264, -0.147118], [-0.043543, -0.143541], [-0.057402999999999996, -0.13858199999999998], [-0.07071, -0.132288], [-0.083336, -0.12472], [-0.095159, -0.115952], [-0.106066, -0.106066], [-0.115952, -0.095159], [-0.12472, -0.083336], [-0.132288, -0.07071], [-0.13858199999999998, -0.057402999999999996], [-0.143541, -0.043543], [-0.147118, -0.029264], [-0.149278, -0.014702999999999999], [-0.15, 0.0], [-0.16999999999999998, 0.0], [-0.169181, -0.016663], [-0.166733, -0.033165], [-0.16268, -0.049347999999999996], [-0.15706, -0.065056], [-0.149927, -0.080137], [-0.14135, -0.09444699999999999], [-0.131412, -0.107847], [-0.120208, -0.120208], [-0.107847, -0.131412], [-0.09444699999999999, -0.14135], [-0.080137, -0.149927], [-0.065056, -0.15706], [-0.049347999999999996, -0.16268], [-0.033165, -0.166733], [-0.016663, -0.169181], [0.0, -0.16999999999999998]], 1),

            ([[0.11499999999999999, 0.0], [0.11444599999999999, -0.011271999999999999], [0.11279, -0.022435], [0.11004799999999999, -0.033382999999999996], [0.106246, -0.044009], [0.101421, -0.054210999999999995], [0.095619, -0.063891], [0.088896, -0.07295499999999999], [0.081317, -0.081317], [0.07295499999999999, -0.088896], [0.063891, -0.095619], [0.054210999999999995, -0.101421], [0.044009, -0.106246], [0.033382999999999996, -0.11004799999999999], [0.022435, -0.11279], [0.011271999999999999, -0.11444599999999999], [0.0, -0.11499999999999999], [-0.011271999999999999, -0.11444599999999999], [-0.022435, -0.11279], [-0.033382999999999996, -0.11004799999999999], [-0.044009, -0.106246], [-0.054210999999999995, -0.101421], [-0.063891, -0.095619], [-0.07295499999999999, -0.088896], [-0.081317, -0.081317], [-0.088896, -0.07295499999999999], [-0.095619, -0.063891], [-0.101421, -0.054210999999999995], [-0.106246, -0.044009], [-0.11004799999999999, -0.033382999999999996], [-0.11279, -0.022435], [-0.11444599999999999, -0.011271999999999999], [-0.11499999999999999, 0.0], [-0.11444599999999999, 0.011271999999999999], [-0.11279, 0.022435], [-0.11004799999999999, 0.033382999999999996], [-0.106246, 0.044009], [-0.101421, 0.054210999999999995], [-0.095619, 0.063891], [-0.088896, 0.07295499999999999], [-0.081317, 0.081317], [-0.07295499999999999, 0.088896], [-0.063891, 0.095619], [-0.054210999999999995, 0.101421], [-0.044009, 0.106246], [-0.033382999999999996, 0.11004799999999999], [-0.022435, 0.11279], [-0.011271999999999999, 0.11444599999999999], [0.0, 0.11499999999999999], [0.011271999999999999, 0.11444599999999999], [0.022435, 0.11279], [0.033382999999999996, 0.11004799999999999], [0.044009, 0.106246], [0.054210999999999995, 0.101421], [0.063891, 0.095619], [0.07295499999999999, 0.088896], [0.081317, 0.081317], [0.088896, 0.07295499999999999], [0.095619, 0.063891], [0.101421, 0.054210999999999995], [0.106246, 0.044009], [0.11004799999999999, 0.033382999999999996], [0.11279, 0.022435], [0.11444599999999999, 0.011271999999999999], [0.11499999999999999, 0.0]], 1),

            ([[-0.75, 0.265], [-0.75, 0.27499999999999997], [0.09999999999999999, 0.27499999999999997], [0.09999999999999999, 0.265]], 1),

            ([[0.75, -0.045], [0.75, -0.034999999999999996], [0.448333, -0.034999999999999996], [0.36928, -0.09429], [0.30311699999999997, -0.066883], [0.275412, 0.0], [0.30311699999999997, 0.066883], [0.36928, 0.09429], [0.448333, 0.034999999999999996], [0.75, 0.034999999999999996], [0.75, 0.045], [0.451667, 0.045], [0.37072, 0.10571], [0.295463, 0.07453699999999999], [0.264588, 0.0], [0.295463, -0.07453699999999999], [0.37072, -0.10571], [0.451667, -0.045]], 1),

            ([[0.8999999999999999, 0.6], [-0.8999999999999999, 0.6], [-0.8999999999999999, -0.5], [-0.75, -0.5], [-0.75, 0.5], [0.75, 0.5], [0.75, -0.5], [-0.75, -0.5], [-0.8999999999999999, -0.5], [-0.8999999999999999, -0.6], [0.8999999999999999, -0.6]], 1),

            ([[-0.7749999999999999, -0.525], [-0.7749999999999999, 0.525], [0.7749999999999999, 0.525], [0.7749999999999999, -0.525], [-0.7749999999999999, -0.525]], 1),

        ]

        for points in polygon_data:
            layer = points[-1]
            polygon_points = points[0]
            self.cell.add(gdspy.Polygon(polygon_points, layer=layer))

    def _calculate_bounding_box(self):
        min_x, min_y = float("inf"), float("inf")
        max_x, max_y = float("-inf"), float("-inf")

        for polygon in self.cell.polygons:
            bbox = polygon.get_bounding_box()
            if bbox is not None:
                min_x = min(min_x, bbox[0][0])
                min_y = min(min_y, bbox[0][1])
                max_x = max(max_x, bbox[1][0])
                max_y = max(max_y, bbox[1][1])

        if min_x == float("inf") or min_y == float("inf"):
            raise ValueError("No valid polygons found in the cell.")

        return min_x, min_y, max_x, max_y

    def _transform_polygons(self, dx, dy, rotation, center):
        for polygon in self.cell.polygons:
            polygon.translate(dx, dy)
            polygon.rotate(rotation, center=center)

    def calc_general_ops(self):
        self.lib = gdspy.GdsLibrary()
        gdspy.library.use_current_library = False
        self.cell = self.lib.new_cell(self.name + "_cell")

        self._add_polygons_to_cell()

        # Bounding box calculations
        min_x, min_y, max_x, max_y = self._calculate_bounding_box()
        current_center_x = (min_x + max_x) / 2
        current_center_y = (min_y + max_y) / 2

        # Target center
        target_center_x, target_center_y = self.options.gds_pos
        dx = target_center_x - current_center_x
        dy = target_center_y - current_center_y

        # Update gds_pos to match adjusted center
        self.options.gds_pos = (target_center_x, target_center_y)

        # Apply transformations
        self._transform_polygons(dx, dy, self.rotation, center=(target_center_x, target_center_y))
        self.outline = [
            points for polygon in self.cell.polygons for points in polygon.get_bounding_box().tolist()
        ]
        return

    def draw_gds(self):
        self.calc_general_ops()
